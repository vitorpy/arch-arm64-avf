# Maintainer: Your Name <your.email@example.com>
pkgname=avf-forwarder-guest-launcher
pkgver=16.0.0.r2
pkgrel=1
pkgdesc="AVF guest service launcher for forwarder with BPF support"
arch=('aarch64')
url="https://android.googlesource.com/platform/packages/modules/Virtualization"
license=('Apache')
depends=('gcc-libs' 'bcc')
makedepends=('rust' 'cargo' 'protobuf' 'git')
source=("avf::git+https://android.googlesource.com/platform/packages/modules/Virtualization#tag=android-16.0.0_r2"
        "guest-tcpstates.patch")
sha256sums=('SKIP'
            'SKIP')

_srcdir="forwarder_guest_launcher"

prepare() {
    cd "$srcdir/avf/guest/$_srcdir"

    # Apply patch for TCP state monitoring
    patch -p1 < "$srcdir/guest-tcpstates.patch"

    # Remove cargo config that may interfere with Arch builds
    rm -f .cargo/config.toml

    # Generate Cargo.lock if it doesn't exist
    cargo generate-lockfile
}

build() {
    cd "$srcdir/avf/guest/$_srcdir"

    export RUSTFLAGS="-C linker=gcc"
    cargo build --release --locked
}

check() {
    cd "$srcdir/avf/guest/$_srcdir"
    cargo test --release --locked
}

package() {
    cd "$srcdir/avf/guest/$_srcdir"

    install -Dm755 "target/release/$_srcdir" "$pkgdir/usr/bin/$pkgname"
}
