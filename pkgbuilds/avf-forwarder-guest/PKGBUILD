# Maintainer: Your Name <your.email@example.com>
pkgname=avf-forwarder-guest
pkgver=16.0.0.r2
pkgrel=1
pkgdesc="AVF guest service for port forwarding"
arch=('aarch64')
url="https://android.googlesource.com/platform/packages/modules/Virtualization"
license=('Apache')
depends=('gcc-libs')
makedepends=('rust' 'cargo' 'protobuf' 'git')
source=("avf::git+https://android.googlesource.com/platform/packages/modules/Virtualization#tag=android-16.0.0_r2")
sha256sums=('SKIP')

_srcdir="forwarder_guest"

prepare() {
    cd "$srcdir/avf/guest/$_srcdir"

    # Remove cargo config that may interfere with Arch builds
    rm -f .cargo/config.toml

    # Generate Cargo.lock if it doesn't exist
    cargo generate-lockfile
}

build() {
    cd "$srcdir/avf/guest/$_srcdir"

    export RUSTFLAGS="-C linker=gcc"
    cargo build --release --locked
}

check() {
    cd "$srcdir/avf/guest/$_srcdir"
    cargo test --release --locked
}

package() {
    cd "$srcdir/avf/guest/$_srcdir"

    install -Dm755 "target/release/$_srcdir" "$pkgdir/usr/bin/$pkgname"
}
